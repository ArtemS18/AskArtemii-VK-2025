{% extends 'base.html' %}

{%block content%}
    <h4>
        {%block question_title%}
            <span class="badge text-bg-primary"> Новые</span>
            <span class="badge text-bg-secondary"> 
                <a class="link-light text-decoration-none" href="{{URL_HOT_QUESTION}}">Популярные</a> 
            </span> 
        {%endblock%}
    </h4>
    {%for question in questions%}
      <article class="card mb-3 shadow-sm" data-question-id="{{ question.id }}">
        <div class="card-body p-3">
         <div class="d-flex gap-3 flex-column">
           <div class="d-flex">
               <div>
                   <div class="me-3">
                   <a href="{{ URL_USER }}/{{ question.author.id }}">
                       <img src="{{ question.author.profile.img_url or url_for('static', path='/images/default-avatar.png') }}"
                               alt="avatar"
                               class="rounded-circle"
                               width="56" height="56"
                               style="object-fit:cover;">
                   </a>
                   </div>
               </div>
               <header>
                   <div>
                   <a href="{{ URL_QUESTION }}/{{ question.id }}" class="text-decoration-none">
                       <h5 class="mb-1 text-light">{{ question.title }}</h5>
                   </a>
                   <div class="mb-2">
                       {% for tag in question.tags %}
                       <a class="badge bg-dark text-decoration-none me-1" href="{{ URL_HOT_TAGS }}/{{ tag.id }}">{{ tag.name }}</a>
                       {% endfor %}
                   </div>
                   </div>
              </header>
           </div>
             <div>
                   <div class="small text-body-secondary d-flex align-items-center" style="gap:.6rem;">
                       <a class="d-flex align-items-center text-decoration-none link-secondary" href="{{ URL_USER }}/{{ question.author.id }}">
                           <strong class="me-2 small">{{ question.author.profile.nickname }}</strong>
                       </a>
                       <span class="text-muted">•</span>
                       <time datetime="{{ question.created_at.isoformat() }}">{{ question.created_at.strftime("%d-%m-%Y %H:%M") }}</time>
                   </div>
               </div>
           <div class="flex-grow-1">
             
             <p class="mb-2 text-muted small" style="line-height:1.4; max-height:4.2em; overflow:hidden;">
               {{ question.text }}
             </p>

            <div class="d-flex align-items-center" style="gap:.5rem;">
                <button class="btn btn-outline-secondary btn-sm grade-btn d-flex align-items-center position-relative
                                {% if (question.grade | length > 0) and (question.grade[0].is_like) %}liked-like text-white{% endif %}"
                        type="button"
                        aria-label="like"
                        data-question-id="{{ question.id }}"
                        data-is-like="true">
                    <i class="bi bi-hand-thumbs-up me-1"></i>
                    <span class="like-count small text-muted">{{ question.like_count or 0 }}</span>
                </button>

                <button class="btn btn-outline-secondary btn-sm grade-btn d-flex align-items-center position-relative
                                {% if (question.grade | length > 0) and (not question.grade[0].is_like) %}liked-dislike text-white{% endif %}"
                        type="button"
                        aria-label="dislike"
                        data-question-id="{{ question.id }}"
                        data-is-like="false">
                    <i class="bi bi-hand-thumbs-down me-1"></i>
                    <span class="dislike-count small text-muted">{{ question.dislike_count or 0 }}</span>
                </button>

                <a href="{{ URL_QUESTION }}/{{ question.id }}" class="btn btn-outline-secondary btn-sm d-flex align-items-center text-decoration-none">
                    <i class="bi bi-chat-left-dots me-1"></i>
                    <span class="small text-muted">{{ question.answers_count or 0 }}</span>
                </a>
            </div>

           </div>
         </div>
        </div>
      </article>
    {%endfor%}
    {%block pagination%}
      {% include 'pagination.html' %}
    {%endblock%}
{%endblock%}

{%block scripts%}
<script>
$(document).ready(function() {
  var csrfToken = $('meta[name="csrf-token"]').attr('content') || '';

  function applyButtonState($btn, active) {
    var isLike = String($btn.data('is-like')) === "true";

    $btn.toggleClass('liked-like', active && isLike);
    $btn.toggleClass('liked-dislike', active && !isLike);

    if (active) {
      $btn.removeClass('btn-outline-secondary')
          .addClass(isLike ? 'btn-primary text-white' : 'btn-danger text-white');
    } else {
      $btn.removeClass('btn-primary btn-danger text-white')
          .addClass('btn-outline-secondary');
    }
  }

  $('.grade-btn').on('click', function(e) {
    e.preventDefault();

    var $btn = $(this);
    var questionId = $btn.data('question-id');
    var isLike = String($btn.data('is-like')) === "true";

    // Кнопки в рамках одного question
    var $card = $btn.closest('article[data-question-id]');
    var $likeBtn = $card.find('.grade-btn[data-is-like="true"]');
    var $dislikeBtn = $card.find('.grade-btn[data-is-like="false"]');
    var $isActive = $likeBtn.hasClass('liked-like') || $dislikeBtn.hasClass('liked-dislike');

    var wasActive = $btn.hasClass(isLike ? 'liked-like' : 'liked-dislike');
    var method;
    if ($isActive) {
      if (wasActive) {
        method = "DELETE";
      } else {
        method = "PUT";
      }
    } else {
      method = "POST";
    }

    if (method === "POST") {
      applyButtonState($likeBtn, isLike);
      applyButtonState($dislikeBtn, !isLike);
    }
    else if (method === "PUT") {
        applyButtonState($likeBtn, isLike);
        applyButtonState($dislikeBtn, !isLike);
    } else {
      applyButtonState($btn, false);
    }

    $.ajax({
      url: '/grade/like/',   
      method: method,
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify({ is_like: isLike, question_id: questionId }),
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      success: function(data) {
        $card.find('.like-count').text(data.like_count);
        $card.find('.dislike-count').text(data.dislike_count);
      },
      error: function(xhr) {
        if (method === "POST") {
          applyButtonState($likeBtn, $likeBtn.hasClass('liked-like'));
          applyButtonState($dislikeBtn, $dislikeBtn.hasClass('liked-dislike'));
        } else {
          applyButtonState($btn, true);
        }
      }
    });
  });
});
</script>

<style>
/* LIKE active */
.grade-btn.liked-like {
  background-color: var(--bs-primary) !important;
  border-color: var(--bs-primary) !important;
}
.grade-btn.liked-like .text-muted {
  color: white !important;
}

/* DISLIKE active */
.grade-btn.liked-dislike {
  background-color: var(--bs-danger) !important;
  border-color: var(--bs-danger) !important;
}
.grade-btn.liked-dislike .text-muted {
  color: white !important;
}
</style>
{%endblock%}